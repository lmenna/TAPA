"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.comparePoloniexCoinbase = comparePoloniexCoinbase;
exports.compareAllPoloniexBittrex = compareAllPoloniexBittrex;

var _sendEMail = require("./sendEMail");

// Set this to be a clear trading opportunity
var arbEmailThresholdPercent = 1.25; // Set this to be the fees associated with trading

var arbReportingThresholdPercent = 0.25;

function formatTimestamp(timeStamp) {
  return timeStamp.toString().slice(0, 25);
}

function comparePoloniexCoinbase(poloData, cbData, coin) {
  var poloJSON = JSON.parse(poloData.exchangeData);
  var cbJSON = JSON.parse(cbData.exchangeData);
  var timeStamp = new Date();
  console.log("".concat(formatTimestamp(timeStamp), ": PoloTime-CBTime: ").concat(poloData.timeStamp.getTime() - cbData.timeStamp.getTime(), "."));
  compareCurrencyPair(timeStamp, poloJSON, cbJSON, "USDC", coin);
}

function compareCurrencyPair(timeStamp, poloJSON, cbJSON, ccy1, ccy2) {
  var poloPair = ccy1 + "_" + ccy2;
  var poloBuyAt = +poloJSON[poloPair].lowestAsk;
  var cbSellAt = +cbJSON.bids[0][0];
  var arbOpportunity = cbSellAt - poloBuyAt;
  var arbPercent = 100 * (cbSellAt - poloBuyAt) / ((cbSellAt + poloBuyAt) / 2);

  if (arbPercent > arbReportingThresholdPercent) {
    var msg = "".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: GAIN, Desc: ").concat(poloPair, ". BUY Polo at: poloBuyAt: ").concat(poloBuyAt, " SELL Coinbase at: ").concat(cbSellAt, ", Amount: ").concat(arbOpportunity);
    if (arbPercent > arbEmailThresholdPercent) (0, _sendEMail.SendMessage)("".concat(poloPair, ": BUY ").concat(ccy2, " at Poloniex and SELL at Coinbase"), msg);
    console.log(msg);
  } else {
    console.log("".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: LOSS, Desc: poloBuyAt: ").concat(poloBuyAt, " compared to cbSellAt: ").concat(cbSellAt, ", DIFF: ").concat(arbOpportunity.toFixed(6)));
  }

  var cbBuyAt = +cbJSON.asks[0][0];
  var poloSellAt = +poloJSON[poloPair].highestBid;
  arbOpportunity = poloSellAt - cbBuyAt;
  arbPercent = 100 * (poloSellAt - cbBuyAt) / ((poloSellAt + cbBuyAt) / 2);

  if (arbPercent > arbReportingThresholdPercent) {
    var _msg = "".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: GAIN, Desc: ").concat(poloPair, ". BUY Coinbase at: cbBuyAt: ").concat(cbBuyAt, " SELL Polo at: ").concat(poloSellAt, ", Gain: ").concat(arbOpportunity);

    if (arbPercent > arbEmailThresholdPercent) (0, _sendEMail.SendMessage)("".concat(poloPair, ": BUY ").concat(ccy2, " at Coinbase and SELL at Poloniex"), _msg);
    console.log(_msg);
  } else {
    console.log("".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: LOSS, Desc: cbBuyAt: ").concat(cbBuyAt, " compared to poloSellAt: ").concat(poloSellAt, ", DIFF: ").concat(arbOpportunity.toFixed(6)));
  }
}

function comparePoloBittrexCcyPair(poloJSON, bittrexJSON, baseCcy, coin) {
  var timeStamp = new Date();
  var poloPair = baseCcy + "_" + coin.toUpperCase();
  var poloBuyAt = +poloJSON[poloPair].lowestAsk;
  var poloSellAt = +poloJSON[poloPair].highestBid;
  var bittrexSellAt = bittrexJSON.result[0].Bid;
  var bittrexBuyAt = bittrexJSON.result[0].Ask;
  var arbOpportunity = poloSellAt - bittrexBuyAt;

  if (arbOpportunity > arbReportingThreshold) {
    var msg = "".concat(timeStamp, ": Pair: ").concat(poloPair, ", Result: GAIN, Desc: ").concat(poloPair, ". BUY ").concat(coin, " at Bittrex: bittrexBuyAt, ").concat(bittrexBuyAt, " SELL Polo at, ").concat(poloSellAt, ", Gain, ").concat(arbOpportunity);
    if (arbOpportunity > arbEmailThreshold) (0, _sendEMail.SendMessage)("".concat(poloPair, ": BUY ").concat(coin, " at Bittrex and SELL at Poloniex"), msg);
    console.log(msg);
  } else {
    console.log("".concat(timeStamp, ": Pair: ").concat(poloPair, ", Result: LOSS, Desc: bittrexBuyAt, ").concat(bittrexBuyAt, " is greater than poloSellAt, ").concat(poloSellAt, ". DIFF, ").concat(arbOpportunity.toFixed(6)));
  }

  arbOpportunity = bittrexSellAt - poloBuyAt;

  if (arbOpportunity > arbReportingThreshold) {
    var _msg2 = "".concat(timeStamp, ": Pair: ").concat(poloPair, ", Result: GAIN, Desc: ").concat(poloPair, ". BUY ").concat(coin, " at Polo: poloBuyAt, ").concat(poloBuyAt, " SELL Bittrex at, ").concat(bittrexSellAt, ", Gain, ").concat(arbOpportunity);

    if (arbOpportunity > arbEmailThreshold) (0, _sendEMail.SendMessage)("".concat(poloPair, ": BUY ").concat(coin, " at Poloniex and SELL at Bittrex"), _msg2);
    console.log(_msg2);
  } else {
    console.log("".concat(timeStamp, ": Pair: ").concat(poloPair, ", Result: LOSS, Desc: poloBuyAt, ").concat(poloBuyAt, " is greater than bittrexSellAt, ").concat(bittrexSellAt, ". DIFF, ").concat(arbOpportunity.toFixed(6)));
  }
}

function comparePoloniexBittrex(poloniexData, bittrexData, basecoin, coins) {
  var timeStamp = new Date();
  var poloJSON = JSON.parse(poloniexData.exchangeData);
  coins.forEach(function (coin) {
    var bittrexJSON = JSON.parse(bittrexData[coin].exchangeData);
    console.log("".concat(timeStamp, ": PoloTime-BittrexTime: ").concat(poloniexData.timeStamp.getTime() - bittrexData[coin].timeStamp.getTime(), "."));
    comparePoloBittrexCcyPair(poloJSON, bittrexJSON, basecoin, coin);
  });
}

function compareAllPoloniexBittrex(poloJSON, bittrexJSON) {
  var reportingTimestamp = new Date();
  var poloTimestamp = poloJSON.timeStamp;
  var poloAllMarkets = JSON.parse(poloJSON.exchangeData);
  var bittrexTimestamp = bittrexJSON.timeStamp;
  console.log(poloTimestamp);
  console.log(bittrexTimestamp);

  for (var bittrexMkt in bittrexJSON.exchangeData) {
    var poloMktName = poloMktFromBittrexName(bittrexMkt);
    var poloMktElement = poloAllMarkets[poloMktName];
    comparePoloniexBittrexMktElement(poloMktElement, bittrexJSON.exchangeData[bittrexMkt], poloMktName, reportingTimestamp);
  }
}

function comparePoloniexBittrexMktElement(poloJSON, bittrexJSON, poloPair, timeStamp) {
  var poloBuyAt = +poloJSON.lowestAsk;
  var poloSellAt = +poloJSON.highestBid;
  var bittrexSellAt = +bittrexJSON.Bid;
  var bittrexBuyAt = +bittrexJSON.Ask;
  var arbOpportunity = poloSellAt - bittrexBuyAt;
  var arbPercent = 100 * (poloSellAt - bittrexBuyAt) / ((poloSellAt + bittrexBuyAt) / 2);

  if (arbPercent > arbReportingThresholdPercent) {
    var msg = "".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: GAIN, Desc: ").concat(poloPair, ". BUY at Bittrex: bittrexBuyAt, ").concat(bittrexBuyAt, " SELL Polo at, ").concat(poloSellAt, ", Gain, ").concat(arbOpportunity.toFixed(6), ", ").concat(arbPercent.toFixed(6), "%");
    console.log(msg);

    if (arbPercent > arbEmailThresholdPercent) {
      var msgBody = "".concat(poloPair, "\n\n").concat(poloPair, " BUY at Bittrex for ").concat(bittrexBuyAt, ".  Sell at Poloniex for ").concat(poloSellAt, "\n");
      (0, _sendEMail.SendMessage)("".concat(poloPair, ": BUY at Bittrex and SELL at Poloniex"), msgBody);
    }
  } else {
    console.log("".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: LOSS, Desc: bittrexBuyAt, ").concat(bittrexBuyAt, " is greater than poloSellAt, ").concat(poloSellAt, ". DIFF, ").concat(arbOpportunity.toFixed(6)));
  }

  arbOpportunity = bittrexSellAt - poloBuyAt;
  arbPercent = 100 * (bittrexSellAt - poloBuyAt) / ((bittrexSellAt + poloBuyAt) / 2);

  if (arbPercent > arbReportingThresholdPercent) {
    var _msg3 = "".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: GAIN, Desc: ").concat(poloPair, ". BUY at Polo: poloBuyAt, ").concat(poloBuyAt, " SELL Bittrex at, ").concat(bittrexSellAt, ", Gain, ").concat(arbOpportunity.toFixed(6), ", ").concat(arbPercent.toFixed(6), "%");

    console.log(_msg3);

    if (arbPercent > arbEmailThresholdPercent) {
      var _msgBody = "".concat(poloPair, "\n\n").concat(poloPair, " BUY at Polo for ").concat(poloBuyAt, ".  Sell at Bittrex for ").concat(bittrexSellAt);

      (0, _sendEMail.SendMessage)("".concat(poloPair, ": BUY at Poloniex and SELL at Bittrex"), _msgBody);
    }
  } else {
    console.log("".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: LOSS, Desc: poloBuyAt, ").concat(poloBuyAt, " is greater than bittrexSellAt, ").concat(bittrexSellAt, ". DIFF, ").concat(arbOpportunity.toFixed(6)));
  }
}

function poloMktFromBittrexName(bittrexMktName) {
  return bittrexMktName.replace("-", "_");
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9jb21wYXJlUHJpY2luZ0RhdGEuanMiXSwibmFtZXMiOlsiYXJiRW1haWxUaHJlc2hvbGRQZXJjZW50IiwiYXJiUmVwb3J0aW5nVGhyZXNob2xkUGVyY2VudCIsImZvcm1hdFRpbWVzdGFtcCIsInRpbWVTdGFtcCIsInRvU3RyaW5nIiwic2xpY2UiLCJjb21wYXJlUG9sb25pZXhDb2luYmFzZSIsInBvbG9EYXRhIiwiY2JEYXRhIiwiY29pbiIsInBvbG9KU09OIiwiSlNPTiIsInBhcnNlIiwiZXhjaGFuZ2VEYXRhIiwiY2JKU09OIiwiRGF0ZSIsImNvbnNvbGUiLCJsb2ciLCJnZXRUaW1lIiwiY29tcGFyZUN1cnJlbmN5UGFpciIsImNjeTEiLCJjY3kyIiwicG9sb1BhaXIiLCJwb2xvQnV5QXQiLCJsb3dlc3RBc2siLCJjYlNlbGxBdCIsImJpZHMiLCJhcmJPcHBvcnR1bml0eSIsImFyYlBlcmNlbnQiLCJtc2ciLCJ0b0ZpeGVkIiwiY2JCdXlBdCIsImFza3MiLCJwb2xvU2VsbEF0IiwiaGlnaGVzdEJpZCIsImNvbXBhcmVQb2xvQml0dHJleENjeVBhaXIiLCJiaXR0cmV4SlNPTiIsImJhc2VDY3kiLCJ0b1VwcGVyQ2FzZSIsImJpdHRyZXhTZWxsQXQiLCJyZXN1bHQiLCJCaWQiLCJiaXR0cmV4QnV5QXQiLCJBc2siLCJhcmJSZXBvcnRpbmdUaHJlc2hvbGQiLCJhcmJFbWFpbFRocmVzaG9sZCIsImNvbXBhcmVQb2xvbmlleEJpdHRyZXgiLCJwb2xvbmlleERhdGEiLCJiaXR0cmV4RGF0YSIsImJhc2Vjb2luIiwiY29pbnMiLCJmb3JFYWNoIiwiY29tcGFyZUFsbFBvbG9uaWV4Qml0dHJleCIsInJlcG9ydGluZ1RpbWVzdGFtcCIsInBvbG9UaW1lc3RhbXAiLCJwb2xvQWxsTWFya2V0cyIsImJpdHRyZXhUaW1lc3RhbXAiLCJiaXR0cmV4TWt0IiwicG9sb01rdE5hbWUiLCJwb2xvTWt0RnJvbUJpdHRyZXhOYW1lIiwicG9sb01rdEVsZW1lbnQiLCJjb21wYXJlUG9sb25pZXhCaXR0cmV4TWt0RWxlbWVudCIsIm1zZ0JvZHkiLCJiaXR0cmV4TWt0TmFtZSIsInJlcGxhY2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7O0FBRUE7QUFDQSxJQUFNQSx3QkFBd0IsR0FBRyxJQUFqQyxDLENBQ0E7O0FBQ0EsSUFBTUMsNEJBQTRCLEdBQUcsSUFBckM7O0FBR0EsU0FBU0MsZUFBVCxDQUF5QkMsU0FBekIsRUFBb0M7QUFDbEMsU0FBT0EsU0FBUyxDQUFDQyxRQUFWLEdBQXFCQyxLQUFyQixDQUEyQixDQUEzQixFQUE2QixFQUE3QixDQUFQO0FBQ0Q7O0FBRUQsU0FBU0MsdUJBQVQsQ0FBaUNDLFFBQWpDLEVBQTJDQyxNQUEzQyxFQUFtREMsSUFBbkQsRUFBeUQ7QUFFdkQsTUFBSUMsUUFBUSxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0wsUUFBUSxDQUFDTSxZQUFwQixDQUFmO0FBQ0EsTUFBSUMsTUFBTSxHQUFHSCxJQUFJLENBQUNDLEtBQUwsQ0FBV0osTUFBTSxDQUFDSyxZQUFsQixDQUFiO0FBQ0EsTUFBSVYsU0FBUyxHQUFHLElBQUlZLElBQUosRUFBaEI7QUFDQUMsRUFBQUEsT0FBTyxDQUFDQyxHQUFSLFdBQWVmLGVBQWUsQ0FBQ0MsU0FBRCxDQUE5QixnQ0FBK0RJLFFBQVEsQ0FBQ0osU0FBVCxDQUFtQmUsT0FBbkIsS0FBNkJWLE1BQU0sQ0FBQ0wsU0FBUCxDQUFpQmUsT0FBakIsRUFBNUY7QUFDQUMsRUFBQUEsbUJBQW1CLENBQUNoQixTQUFELEVBQVlPLFFBQVosRUFBc0JJLE1BQXRCLEVBQThCLE1BQTlCLEVBQXNDTCxJQUF0QyxDQUFuQjtBQUNEOztBQUVELFNBQVNVLG1CQUFULENBQTZCaEIsU0FBN0IsRUFBd0NPLFFBQXhDLEVBQWtESSxNQUFsRCxFQUEwRE0sSUFBMUQsRUFBZ0VDLElBQWhFLEVBQXNFO0FBQ3BFLE1BQUlDLFFBQVEsR0FBR0YsSUFBSSxHQUFDLEdBQUwsR0FBU0MsSUFBeEI7QUFDQSxNQUFJ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LDRDQUFlakIsUUFBZiw0Q0FBZ0V3QyxRQUFoRTtBQUNEO0FBQ0YsR0FQRCxNQVFLO0FBQ0g5QyxJQUFBQSxPQUFPLENBQUNDLEdBQVIsV0FBZWYsZUFBZSxDQUFDQyxTQUFELENBQTlCLHFCQUFvRG1CLFFBQXBELDhDQUFnR0MsU0FBaEcsNkNBQTRJZ0IsYUFBNUkscUJBQW9LWixjQUFjLENBQUNHLE9BQWYsQ0FBdUIsQ0FBdkIsQ0FBcEs7QUFDRDtBQUNGOztBQUVELFNBQVM2QixzQkFBVCxDQUFnQ0ksY0FBaEMsRUFBZ0Q7QUFDOUMsU0FBT0EsY0FBYyxDQUFDQyxPQUFmLENBQXVCLEdBQXZCLEVBQTRCLEdBQTVCLENBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U2VuZE1lc3NhZ2V9IGZyb20gXCIuL3NlbmRFTWFpbFwiO1xuXG4vLyBTZXQgdGhpcyB0byBiZSBhIGNsZWFyIHRyYWRpbmcgb3Bwb3J0dW5pdHlcbmNvbnN0IGFyYkVtYWlsVGhyZXNob2xkUGVyY2VudCA9IDEuMjU7XG4vLyBTZXQgdGhpcyB0byBiZSB0aGUgZmVlcyBhc3NvY2lhdGVkIHdpdGggdHJhZGluZ1xuY29uc3QgYXJiUmVwb3J0aW5nVGhyZXNob2xkUGVyY2VudCA9IDAuMjU7XG5cblxuZnVuY3Rpb24gZm9ybWF0VGltZXN0YW1wKHRpbWVTdGFtcCkge1xuICByZXR1cm4odGltZVN0YW1wLnRvU3RyaW5nKCkuc2xpY2UoMCwyNSkpO1xufVxuXG5mdW5jdGlvbiBjb21wYXJlUG9sb25pZXhDb2luYmFzZShwb2xvRGF0YSwgY2JEYXRhLCBjb2luKSB7XG5cbiAgdmFyIHBvbG9KU09OID0gSlNPTi5wYXJzZShwb2xvRGF0YS5leGNoYW5nZURhdGEpO1xuICB2YXIgY2JKU09OID0gSlNPTi5wYXJzZShjYkRhdGEuZXhjaGFuZ2VEYXRhKTtcbiAgbGV0IHRpbWVTdGFtcCA9IG5ldyBEYXRlKCk7XG4gIGNvbnNvbGUubG9nKGAke2Zvcm1hdFRpbWVzdGFtcCh0aW1lU3RhbXApfTogUG9sb1RpbWUtQ0JUaW1lOiAke3BvbG9EYXRhLnRpbWVTdGFtcC5nZXRUaW1lKCktY2JEYXRhLnRpbWVTdGFtcC5nZXRUaW1lKCl9LmApO1xuICBjb21wYXJlQ3VycmVuY3lQYWlyKHRpbWVTdGFtcCwgcG9sb0pTT04sIGNiSlNPTiwgXCJVU0RDXCIsIGNvaW4pXG59XG5cbmZ1bmN0aW9uIGNvbXBhcmVDdXJyZW5jeVBhaXIodGltZVN0YW1wLCBwb2xvSlNPTiwgY2JKU09OLCBjY3kxLCBjY3kyKSB7XG4gIGxldCBwb2xvUGFpciA9IGNjeTErXCJfXCIrY2N5MjtcbiAgbGV0IHBvbG9CdXlBdCA9ICtwb2xvSlNPTltwb2xvUGFpcl0ubG93ZXN0QXNrO1xuICBsZXQgY2JTZWxsQXQgPSArY2JKU09OLmJpZHNbMF1bMF07XG4gIGxldCBhcmJPcHBvcnR1bml0eSA9IGNiU2VsbEF0LXBvbG9CdXlBdDtcbiAgbGV0IGFyYlBlcmNlbnQgPSAxMDAqKGNiU2VsbEF0LXBvbG9CdXlBdCkvKCAoY2JTZWxsQXQrcG9sb0J1eUF0KSAvIDIpO1xuICBpZihhcmJQZXJjZW50ID4gYXJiUmVwb3J0aW5nVGhyZXNob2xkUGVyY2VudCkge1xuICAgIGxldCBtc2cgPSBgJHtmb3JtYXRUaW1lc3RhbXAodGltZVN0YW1wKX06IFBhaXI6ICR7cG9sb1BhaXJ9LCBSZXN1bHQ6IEdBSU4sIERlc2M6ICR7cG9sb1BhaXJ9LiBCVVkgUG9sbyBhdDogcG9sb0J1eUF0OiAke3BvbG9CdXlBdH0gU0VMTCBDb2luYmFzZSBhdDogJHtjYlNlbGxBdH0sIEFtb3VudDogJHthcmJPcHBvcnR1bml0eX1gO1xuICAgIGlmIChhcmJQZXJjZW50ID4gYXJiRW1haWxUaHJlc2hvbGRQZXJjZW50KVxuICAgICAgU2VuZE1lc3NhZ2UoYCR7cG9sb1BhaXJ9OiBCVVkgJHtjY3kyfSBhdCBQb2xvbmlleCBhbmQgU0VMTCBhdCBDb2luYmFzZWAsIG1zZyk7XG4gICAgY29uc29sZS5sb2cobXNnKTtcbiAgfVxuICBlbHNlIHtcbiAgICBjb25zb2xlLmxvZyhgJHtmb3JtYXRUaW1lc3RhbXAodGltZVN0YW1wKX06IFBhaXI6ICR7cG9sb1BhaXJ9LCBSZXN1bHQ6IExPU1MsIERlc2M6IHBvbG9CdXlBdDogJHtwb2xvQnV5QXR9IGNvbXBhcmVkIHRvIGNiU2VsbEF0OiAke2NiU2VsbEF0fSwgRElGRjogJHthcmJPcHBvcnR1bml0eS50b0ZpeGVkKDYpfWApXG4gIH1cbiAgbGV0IGNiQnV5QXQgPSArY2JKU09OLmFza3NbMF1bMF07XG4gIGxldCBwb2xvU2VsbEF0ID0gK3BvbG9KU09OW3BvbG9QYWlyXS5oaWdoZXN0QmlkO1xuICBhcmJPcHBvcnR1bml0eSA9IHBvbG9TZWxsQXQtY2JCdXlBdDtcbiAgYXJiUGVyY2VudCA9IDEwMCoocG9sb1NlbGxBdC1jYkJ1eUF0KS8oIChwb2xvU2VsbEF0K2NiQnV5QXQpIC8gMik7XG4gIGlmKGFyYlBlcmNlbnQgPiBhcmJSZXBvcnRpbmdUaHJlc2hvbGRQZXJjZW50KSB7XG4gICAgbGV0IG1zZyA9IGAke2Zvcm1hdFRpbWVzdGFtcCh0aW1lU3RhbXApfTogUGFpcjogJHtwb2xvUGFpcn0sIFJlc3VsdDogR0FJTiwgRGVzYzogJHtwb2xvUGFpcn0uIEJVWSBDb2luYmFzZSBhdDogY2JCdXlBdDogJHtjYkJ1eUF0fSBTRUxMIFBvbG8gYXQ6ICR7cG9sb1NlbGxBdH0sIEdhaW46ICR7YXJiT3Bwb3J0dW5pdHl9YDtcbiAgICBpZiAoYXJiUGVyY2VudCA+IGFyYkVtYWlsVGhyZXNob2xkUGVyY2VudCkgXG4gICAgICBTZW5kTWVzc2FnZShgJHtwb2xvUGFpcn06IEJVWSAke2NjeTJ9IGF0IENvaW5iYXNlIGFuZCBTRUxMIGF0IFBvbG9uaWV4YCwgbXNnKTtcbiAgICBjb25zb2xlLmxvZyhtc2cpO1xuICB9XG4gIGVsc2Uge1xuICAgIGNvbnNvbGUubG9nKGAke2Zvcm1hdFRpbWVzdGFtcCh0aW1lU3RhbXApfTogUGFpcjogJHtwb2xvUGFpcn0sIFJlc3VsdDogTE9TUywgRGVzYzogY2JCdXlBdDogJHtjYkJ1eUF0fSBjb21wYXJlZCB0byBwb2xvU2VsbEF0OiAke3BvbG9TZWxsQXR9LCBESUZGOiAke2FyYk9wcG9ydHVuaXR5LnRvRml4ZWQoNil9YCk7XG4gIH1cbiB9XG5cbmZ1bmN0aW9uIGNvbXBhcmVQb2xvQml0dHJleENjeVBhaXIocG9sb0pTT04sIGJpdHRyZXhKU09OLCBiYXNlQ2N5LCBjb2luKSB7XG5cbiAgbGV0IHRpbWVTdGFtcCA9IG5ldyBEYXRlKCk7XG4gIGxldCBwb2xvUGFpciA9IGJhc2VDY3kgKyBcIl9cIiArIGNvaW4udG9VcHBlckNhc2UoKTtcbiAgbGV0IHBvbG9CdXlBdCA9ICtwb2xvSlNPTltwb2xvUGFpcl0ubG93ZXN0QXNrO1xuICBsZXQgcG9sb1NlbGxBdCA9ICtwb2xvSlNPTltwb2xvUGFpcl0uaGlnaGVzdEJpZDtcbiAgbGV0IGJpdHRyZXhTZWxsQXQgPSBiaXR0cmV4SlNPTi5yZXN1bHRbMF0uQmlkO1xuICBsZXQgYml0dHJleEJ1eUF0ID0gYml0dHJleEpTT04ucmVzdWx0WzBdLkFzaztcbiAgbGV0IGFyYk9wcG9ydHVuaXR5ID0gcG9sb1NlbGxBdC1iaXR0cmV4QnV5QXQ7XG4gIGlmKGFyYk9wcG9ydHVuaXR5ID4gYXJiUmVwb3J0aW5nVGhyZXNob2xkKSB7XG4gICAgbGV0IG1zZyA9IGAke3RpbWVTdGFtcH06IFBhaXI6ICR7cG9sb1BhaXJ9LCBSZXN1bHQ6IEdBSU4sIERlc2M6ICR7cG9sb1BhaXJ9LiBCVVkgJHtjb2lufSBhdCBCaXR0cmV4OiBiaXR0cmV4QnV5QXQsICR7Yml0dHJleEJ1eUF0fSBTRUxMIFBvbG8gYXQsICR7cG9sb1NlbGxBdH0sIEdhaW4sICR7YXJiT3Bwb3J0dW5pdHl9YDtcbiAgICBpZiAoYXJiT3Bwb3J0dW5pdHkgPiBhcmJFbWFpbFRocmVzaG9sZClcbiAgICAgIFNlbmRNZXNzYWdlKGAke3BvbG9QYWlyfTogQlVZICR7Y29pbn0gYXQgQml0dHJleCBhbmQgU0VMTCBhdCBQb2xvbmlleGAsIG1zZyk7XG4gICAgY29uc29sZS5sb2cobXNnKTtcbiAgfVxuICBlbHNlIHtcbiAgICBjb25zb2xlLmxvZyhgJHt0aW1lU3RhbXB9OiBQYWlyOiAke3BvbG9QYWlyfSwgUmVzdWx0OiBMT1NTLCBEZXNjOiBiaXR0cmV4QnV5QXQsICR7Yml0dHJleEJ1eUF0fSBpcyBncmVhdGVyIHRoYW4gcG9sb1NlbGxBdCwgJHtwb2xvU2VsbEF0fS4gRElGRiwgJHthcmJPcHBvcnR1bml0eS50b0ZpeGVkKDYpfWApO1xuICB9XG4gIGFyYk9wcG9ydHVuaXR5ID0gYml0dHJleFNlbGxBdC1wb2xvQnV5QXQ7XG4gIGlmKGFyYk9wcG9ydHVuaXR5ID4gYXJiUmVwb3J0aW5nVGhyZXNob2xkKSB7XG4gICAgbGV0IG1zZyA9IGAke3RpbWVTdGFtcH06IFBhaXI6ICR7cG9sb1BhaXJ9LCBSZXN1bHQ6IEdBSU4sIERlc2M6ICR7cG9sb1BhaXJ9LiBCVVkgJHtjb2lufSBhdCBQb2xvOiBwb2xvQnV5QXQsICR7cG9sb0J1eUF0fSBTRUxMIEJpdHRyZXggYXQsICR7Yml0dHJleFNlbGxBdH0sIEdhaW4sICR7YXJiT3Bwb3J0dW5pdHl9YDtcbiAgICBpZiAoYXJiT3Bwb3J0dW5pdHkgPiBhcmJFbWFpbFRocmVzaG9sZClcbiAgICAgIFNlbmRNZXNzYWdlKGAke3BvbG9QYWlyfTogQlVZICR7Y29pbn0gYXQgUG9sb25pZXggYW5kIFNFTEwgYXQgQml0dHJleGAsIG1zZyk7XG4gICAgY29uc29sZS5sb2cobXNnKTtcbiAgfVxuICBlbHNlIHtcbiAgICBjb25zb2xlLmxvZyhgJHt0aW1lU3RhbXB9OiBQYWlyOiAke3BvbG9QYWlyfSwgUmVzdWx0OiBMT1NTLCBEZXNjOiBwb2xvQnV5QXQsICR7cG9sb0J1eUF0fSBpcyBncmVhdGVyIHRoYW4gYml0dHJleFNlbGxBdCwgJHtiaXR0cmV4U2VsbEF0fS4gRElGRiwgJHthcmJPcHBvcnR1bml0eS50b0ZpeGVkKDYpfWApO1xuICB9XG59IFxuXG5mdW5jdGlvbiBjb21wYXJlUG9sb25pZXhCaXR0cmV4KHBvbG9uaWV4RGF0YSwgYml0dHJleERhdGEsIGJhc2Vjb2luLCBjb2lucykge1xuXG4gIGxldCB0aW1lU3RhbXAgPSBuZXcgRGF0ZSgpO1xuICB2YXIgcG9sb0pTT04gPSBKU09OLnBhcnNlKHBvbG9uaWV4RGF0YS5leGNoYW5nZURhdGEpO1xuICBjb2lucy5mb3JFYWNoKGNvaW4gPT4ge1xuICAgIHZhciBiaXR0cmV4SlNPTiA9IEpTT04ucGFyc2UoYml0dHJleERhdGFbY29pbl0uZXhjaGFuZ2VEYXRhKTtcbiAgICBjb25zb2xlLmxvZyhgJHt0aW1lU3RhbXB9OiBQb2xvVGltZS1CaXR0cmV4VGltZTogJHtwb2xvbmlleERhdGEudGltZVN0YW1wLmdldFRpbWUoKS1iaXR0cmV4RGF0YVtjb2luXS50aW1lU3RhbXAuZ2V0VGltZSgpfS5gKTtcbiAgICBjb21wYXJlUG9sb0JpdHRyZXhDY3lQYWlyKHBvbG9KU09OLCBiaXR0cmV4SlNPTiwgYmFzZWNvaW4sIGNvaW4pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY29tcGFyZUFsbFBvbG9uaWV4Qml0dHJleChwb2xvSlNPTiwgYml0dHJleEpTT04pIHtcblxuICBsZXQgcmVwb3J0aW5nVGltZXN0YW1wID0gbmV3IERhdGUoKTtcbiAgbGV0IHBvbG9UaW1lc3RhbXAgPSBwb2xvSlNPTi50aW1lU3RhbXA7XG4gIGxldCBwb2xvQWxsTWFya2V0cyA9IEpTT04ucGFyc2UocG9sb0pTT04uZXhjaGFuZ2VEYXRhKTtcbiAgbGV0IGJpdHRyZXhUaW1lc3RhbXAgPSBiaXR0cmV4SlNPTi50aW1lU3RhbXA7XG4gIGNvbnNvbGUubG9nKHBvbG9UaW1lc3RhbXApO1xuICBjb25zb2xlLmxvZyhiaXR0cmV4VGltZXN0YW1wKTtcbiAgZm9yKGxldCBiaXR0cmV4TWt0IGluIGJpdHRyZXhKU09OLmV4Y2hhbmdlRGF0YSl7XG4gICAgbGV0IHBvbG9Na3ROYW1lID0gcG9sb01rdEZyb21CaXR0cmV4TmFtZShiaXR0cmV4TWt0KTtcbiAgICBsZXQgcG9sb01rdEVsZW1lbnQgPSBwb2xvQWxsTWFya2V0c1twb2xvTWt0TmFtZV07XG4gICAgY29tcGFyZVBvbG9uaWV4Qml0dHJleE1rdEVsZW1lbnQocG9sb01rdEVsZW1lbnQsIGJpdHRyZXhKU09OLmV4Y2hhbmdlRGF0YVtiaXR0cmV4TWt0XSwgcG9sb01rdE5hbWUsIHJlcG9ydGluZ1RpbWVzdGFtcClcbiAgfVxufVxuXG5mdW5jdGlvbiBjb21wYXJlUG9sb25pZXhCaXR0cmV4TWt0RWxlbWVudChwb2xvSlNPTiwgYml0dHJleEpTT04sIHBvbG9QYWlyLCB0aW1lU3RhbXApIHtcblxuICBsZXQgcG9sb0J1eUF0ID0gK3BvbG9KU09OLmxvd2VzdEFzaztcbiAgbGV0IHBvbG9TZWxsQXQgPSArcG9sb0pTT04uaGlnaGVzdEJpZDtcbiAgbGV0IGJpdHRyZXhTZWxsQXQgPSArYml0dHJleEpTT04uQmlkO1xuICBsZXQgYml0dHJleEJ1eUF0ID0gK2JpdHRyZXhKU09OLkFzaztcbiAgbGV0IGFyYk9wcG9ydHVuaXR5ID0gcG9sb1NlbGxBdC1iaXR0cmV4QnV5QXQ7XG4gIGxldCBhcmJQZXJjZW50ID0gMTAwKihwb2xvU2VsbEF0LWJpdHRyZXhCdXlBdCkvKCAocG9sb1NlbGxBdCtiaXR0cmV4QnV5QXQpIC8gMik7XG4gIGlmKGFyYlBlcmNlbnQgPiBhcmJSZXBvcnRpbmdUaHJlc2hvbGRQZXJjZW50KSB7XG4gICAgbGV0IG1zZyA9IGAke2Zvcm1hdFRpbWVzdGFtcCh0aW1lU3RhbXApfTogUGFpcjogJHtwb2xvUGFpcn0sIFJlc3VsdDogR0FJTiwgRGVzYzogJHtwb2xvUGFpcn0uIEJVWSBhdCBCaXR0cmV4OiBiaXR0cmV4QnV5QXQsICR7Yml0dHJleEJ1eUF0fSBTRUxMIFBvbG8gYXQsICR7cG9sb1NlbGxBdH0sIEdhaW4sICR7YXJiT3Bwb3J0dW5pdHkudG9GaXhlZCg2KX0sICR7YXJiUGVyY2VudC50b0ZpeGVkKDYpfSVgO1xuICAgIGNvbnNvbGUubG9nKG1zZyk7XG4gICAgaWYgKGFyYlBlcmNlbnQgPiBhcmJFbWFpbFRocmVzaG9sZFBlcmNlbnQpIHtcbiAgICAgIGxldCBtc2dCb2R5ID0gYCR7cG9sb1BhaXJ9XFxuXFxuJHtwb2xvUGFpcn0gQlVZIGF0IEJpdHRyZXggZm9yICR7Yml0dHJleEJ1eUF0fS4gIFNlbGwgYXQgUG9sb25pZXggZm9yICR7cG9sb1NlbGxBdH1cXG5gO1xuICAgICAgU2VuZE1lc3NhZ2UoYCR7cG9sb1BhaXJ9OiBCVVkgYXQgQml0dHJleCBhbmQgU0VMTCBhdCBQb2xvbmlleGAsIG1zZ0JvZHkpO1xuICAgIH1cbiAgfVxuICBlbHNlIHtcbiAgICBjb25zb2xlLmxvZyhgJHtmb3JtYXRUaW1lc3RhbXAodGltZVN0YW1wKX06IFBhaXI6ICR7cG9sb1BhaXJ9LCBSZXN1bHQ6IExPU1MsIERlc2M6IGJpdHRyZXhCdXlBdCwgJHtiaXR0cmV4QnV5QXR9IGlzIGdyZWF0ZXIgdGhhbiBwb2xvU2VsbEF0LCAke3BvbG9TZWxsQXR9LiBESUZGLCAke2FyYk9wcG9ydHVuaXR5LnRvRml4ZWQoNil9YCk7XG4gIH1cbiAgYXJiT3Bwb3J0dW5pdHkgPSBiaXR0cmV4U2VsbEF0LXBvbG9CdXlBdDtcbiAgYXJiUGVyY2VudCA9IDEwMCooYml0dHJleFNlbGxBdC1wb2xvQnV5QXQpLyggKGJpdHRyZXhTZWxsQXQrcG9sb0J1eUF0KSAvIDIpO1xuICBpZihhcmJQZXJjZW50ID4gYXJiUmVwb3J0aW5nVGhyZXNob2xkUGVyY2VudCkge1xuICAgIGxldCBtc2cgPSBgJHtmb3JtYXRUaW1lc3RhbXAodGltZVN0YW1wKX06IFBhaXI6ICR7cG9sb1BhaXJ9LCBSZXN1bHQ6IEdBSU4sIERlc2M6ICR7cG9sb1BhaXJ9LiBCVVkgYXQgUG9sbzogcG9sb0J1eUF0LCAke3BvbG9CdXlBdH0gU0VMTCBCaXR0cmV4IGF0LCAke2JpdHRyZXhTZWxsQXR9LCBHYWluLCAke2FyYk9wcG9ydHVuaXR5LnRvRml4ZWQoNil9LCAke2FyYlBlcmNlbnQudG9GaXhlZCg2KX0lYDtcbiAgICBjb25zb2xlLmxvZyhtc2cpO1xuICAgIGlmIChhcmJQZXJjZW50ID4gYXJiRW1haWxUaHJlc2hvbGRQZXJjZW50KSB7XG4gICAgICBsZXQgbXNnQm9keSA9IGAke3BvbG9QYWlyfVxcblxcbiR7cG9sb1BhaXJ9IEJVWSBhdCBQb2xvIGZvciAke3BvbG9CdXlBdH0uICBTZWxsIGF0IEJpdHRyZXggZm9yICR7Yml0dHJleFNlbGxBdH1gO1xuICAgICAgU2VuZE1lc3NhZ2UoYCR7cG9sb1BhaXJ9OiBCVVkgYXQgUG9sb25pZXggYW5kIFNFTEwgYXQgQml0dHJleGAsIG1zZ0JvZHkpO1xuICAgIH1cbiAgfVxuICBlbHNlIHtcbiAgICBjb25zb2xlLmxvZyhgJHtmb3JtYXRUaW1lc3RhbXAodGltZVN0YW1wKX06IFBhaXI6ICR7cG9sb1BhaXJ9LCBSZXN1bHQ6IExPU1MsIERlc2M6IHBvbG9CdXlBdCwgJHtwb2xvQnV5QXR9IGlzIGdyZWF0ZXIgdGhhbiBiaXR0cmV4U2VsbEF0LCAke2JpdHRyZXhTZWxsQXR9LiBESUZGLCAke2FyYk9wcG9ydHVuaXR5LnRvRml4ZWQoNil9YCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gcG9sb01rdEZyb21CaXR0cmV4TmFtZShiaXR0cmV4TWt0TmFtZSkge1xuICByZXR1cm4oYml0dHJleE1rdE5hbWUucmVwbGFjZShcIi1cIiwgXCJfXCIpKTtcbn1cblxuZXhwb3J0IHtjb21wYXJlUG9sb25pZXhDb2luYmFzZSwgY29tcGFyZUFsbFBvbG9uaWV4Qml0dHJleH07XG4iXX0=