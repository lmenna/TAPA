"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.comparePoloniexCoinbase = comparePoloniexCoinbase;
exports.compareAllPoloniexBittrex = compareAllPoloniexBittrex;
exports.compareAllPoloniexHitbtc = compareAllPoloniexHitbtc;

var _sendEMail = require("./sendEMail");

/* comparePricingData.js
 * Consolidates function to compare crypto markets looking for significant arbitrage opportunities.
 * Sends notifications when large arbitrage is detected.
 */
// Set this to be a clear trading opportunity
var arbEmailThresholdPercent = 1.25; // Set this to be the fees associated with trading

var arbReportingThresholdPercent = 0.0;
/* formatTimestamp
 * desc: Simple utility to truncate the output of long time stamps to include only the date and time parts.
 */

function formatTimestamp(timeStamp) {
  return timeStamp.toString().slice(0, 25);
}
/* comparePoloniexCoinbase
 * desc: Main function called to compare the Poloniex and Coinbase crypto markets.
 *       This function is exported and called be app.js
 */


function comparePoloniexCoinbase(poloData, cbData, coin) {
  var poloJSON = JSON.parse(poloData.exchangeData);
  var cbJSON = JSON.parse(cbData.exchangeData);
  var timeStamp = new Date();
  console.log("".concat(formatTimestamp(timeStamp), ": PoloTime-CBTime: ").concat(poloData.timeStamp.getTime() - cbData.timeStamp.getTime(), "."));
  compareCurrencyPair(timeStamp, poloJSON, cbJSON, "USDC", coin);
}
/* compareCurrencyPair
 * desc: Compares a currency pair between Poloniex and Coinbase.  Notifies when significant arbitrage opportunities
 *       occur.
 */


function compareCurrencyPair(timeStamp, poloJSON, cbJSON, ccy1, ccy2) {
  var poloPair = ccy1 + "_" + ccy2;
  var poloBuyAt = +poloJSON[poloPair].lowestAsk;
  var cbSellAt = +cbJSON.bids[0][0];
  var arbOpportunity = cbSellAt - poloBuyAt;
  var arbPercent = 100 * (cbSellAt - poloBuyAt) / ((cbSellAt + poloBuyAt) / 2);

  if (arbPercent > arbReportingThresholdPercent) {
    var msg = "".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: GAIN, Desc: ").concat(poloPair, ". BUY Polo at: poloBuyAt: ").concat(poloBuyAt.toFixed(8), " SELL Coinbase at: ").concat(cbSellAt.toFixed(8), ", Amount: ").concat(arbOpportunity.toFixed(7), ", ").concat(arbPercent.toFixed(6), "%");
    if (arbPercent > arbEmailThresholdPercent) (0, _sendEMail.SendMessage)("".concat(poloPair, ": BUY ").concat(ccy2, " at Poloniex and SELL at Coinbase"), msg);
    console.log(msg);
  } else {
    console.log("".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: LOSS, Desc: poloBuyAt: ").concat(poloBuyAt.toFixed(8), " compared to cbSellAt: ").concat(cbSellAt.toFixed(8), ", DIFF: ").concat(arbOpportunity.toFixed(7)));
  }

  var cbBuyAt = +cbJSON.asks[0][0];
  var poloSellAt = +poloJSON[poloPair].highestBid;
  arbOpportunity = poloSellAt - cbBuyAt;
  arbPercent = 100 * (poloSellAt - cbBuyAt) / ((poloSellAt + cbBuyAt) / 2);

  if (arbPercent > arbReportingThresholdPercent) {
    var _msg = "".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: GAIN, Desc: ").concat(poloPair, ". BUY Coinbase at: cbBuyAt: ").concat(cbBuyAt.toFixed(7), " SELL Polo at: ").concat(poloSellAt.toFixed(7), ", Gain: ").concat(arbOpportunity.toFixed(7), ", ").concat(arbPercent.toFixed(6), "%");

    if (arbPercent > arbEmailThresholdPercent) (0, _sendEMail.SendMessage)("".concat(poloPair, ": BUY ").concat(ccy2, " at Coinbase and SELL at Poloniex"), _msg);
    console.log(_msg);
  } else {
    console.log("".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: LOSS, Desc: cbBuyAt: ").concat(cbBuyAt.toFixed(7), " compared to poloSellAt: ").concat(poloSellAt.toFixed(7), ", DIFF: ").concat(arbOpportunity.toFixed(7)));
  }
}
/* compareAllPoloniexBittrex
 * desc: Takes the poloniex and bittrex data in JSON format and compares all overlaping markets for arbitrage.
 *       Exported function called by the main app.js
 */


function compareAllPoloniexBittrex(poloJSON, bittrexJSON) {
  var reportingTimestamp = new Date();
  var poloTimestamp = poloJSON.timeStamp;
  var poloAllMarkets = JSON.parse(poloJSON.exchangeData);
  var bittrexTimestamp = bittrexJSON.timeStamp;
  console.log(poloTimestamp);
  console.log(bittrexTimestamp);

  for (var bittrexMkt in bittrexJSON.exchangeData) {
    var poloMktName = poloMktFromBittrexName(bittrexMkt);
    var poloMktElement = poloAllMarkets[poloMktName];
    comparePoloniexBittrexMktElement(poloMktElement, bittrexJSON.exchangeData[bittrexMkt], poloMktName, reportingTimestamp);
  }
}
/* comparePoloniexBittrexMktElement
 * desc: Compares a particular market between the Poloniex and Bittrex exchanges.  Sedn notifications when
 *       significant arbitrage opportunities exist.
 */


function comparePoloniexBittrexMktElement(poloJSON, bittrexJSON, poloPair, timeStamp) {
  var poloBuyAt = +poloJSON.lowestAsk;
  var poloSellAt = +poloJSON.highestBid;
  var bittrexSellAt = +bittrexJSON.Bid;
  var bittrexBuyAt = +bittrexJSON.Ask;
  outputArbResults(poloBuyAt, poloSellAt, bittrexSellAt, bittrexBuyAt, "Bittrex", poloPair, timeStamp);
}

function outputArbResults(poloBuyAt, poloSellAt, exchange2SellAt, exchange2BuyAt, exchange2Name, poloPair, timeStamp) {
  var arbOpportunity = poloSellAt - exchange2BuyAt;
  var arbPercent = 100 * (poloSellAt - exchange2BuyAt) / ((poloSellAt + exchange2BuyAt) / 2);

  if (arbPercent > arbReportingThresholdPercent) {
    var msg = "".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: GAIN, Desc: ").concat(poloPair, ". BUY at ").concat(exchange2Name, ": ").concat(exchange2BuyAt.toFixed(8), " SELL Polo at, ").concat(poloSellAt.toFixed(8), ", Gain, ").concat(arbOpportunity.toFixed(7), ", ").concat(arbPercent.toFixed(6), "%");
    console.log(msg);

    if (arbPercent > arbEmailThresholdPercent) {
      var msgBody = "".concat(poloPair, " BUY at ").concat(exchange2Name, " for ").concat(exchange2BuyAt.toFixed(8), ".  Sell at Poloniex for ").concat(poloSellAt.toFixed(8), ", Gain: ").concat(arbPercent.toFixed(6), "%");
      (0, _sendEMail.SendMessage)("".concat(poloPair, ": BUY at ").concat(exchange2Name, " and SELL at Poloniex"), msgBody);
    }
  } else {
    console.log("".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: LOSS, Desc: ").concat(exchange2Name, ", ").concat(exchange2BuyAt.toFixed(8), " is greater than poloSellAt, ").concat(poloSellAt.toFixed(8), ", DIFF, ").concat(arbOpportunity.toFixed(6)));
  }

  arbOpportunity = exchange2SellAt - poloBuyAt;
  arbPercent = 100 * (exchange2SellAt - poloBuyAt) / ((exchange2SellAt + poloBuyAt) / 2);

  if (arbPercent > arbReportingThresholdPercent) {
    var _msg2 = "".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: GAIN, Desc: ").concat(poloPair, ". BUY at Polo: poloBuyAt, ").concat(poloBuyAt.toFixed(8), " SELL ").concat(exchange2Name, " at, ").concat(exchange2SellAt.toFixed(8), ", Gain, ").concat(arbOpportunity.toFixed(7), ", ").concat(arbPercent.toFixed(6), "%");

    console.log(_msg2);

    if (arbPercent > arbEmailThresholdPercent) {
      var _msgBody = "".concat(poloPair, " BUY at Polo for ").concat(poloBuyAt.toFixed(8), ".  Sell at ").concat(exchange2Name, " for ").concat(exchange2SellAt.toFixed(8), ", Gain: ").concat(arbPercent.toFixed(6), "%");

      (0, _sendEMail.SendMessage)("".concat(poloPair, ": BUY at Poloniex and SELL at ").concat(exchange2Name), _msgBody);
    }
  } else {
    console.log("".concat(formatTimestamp(timeStamp), ": Pair: ").concat(poloPair, ", Result: LOSS, Desc: poloBuyAt, ").concat(poloBuyAt.toFixed(8), " is greater than ").concat(exchange2Name, "SellAt, ").concat(exchange2SellAt.toFixed(8), ". DIFF, ").concat(arbOpportunity.toFixed(7)));
  }
}
/* poloMktFromBittrexName
 * desc: Converts a Bittrex crypto currency pair into the Poloniex pair.
 */


function poloMktFromBittrexName(bittrexMktName) {
  return bittrexMktName.replace("-", "_");
}
/* compareAllPoloniexHitbtc
*  desc: Takes the poloniex and hitbtc data in JSON format and compares all overlaping markets for arbitrage.
*       Exported function called by the main app.js
*/


function compareAllPoloniexHitbtc(poloJSON, hitbtcJSON) {
  var reportingTimestamp = new Date();
  var poloTimestamp = poloJSON.timeStamp;
  var poloAllMarkets = JSON.parse(poloJSON.exchangeData);
  var hitbtcTimestamp = hitbtcJSON.timeStamp;
  console.log(poloTimestamp);
  console.log(hitbtcTimestamp);

  for (var hitbtcMkt in hitbtcJSON.exchangeData) {
    var poloMktName = poloMktFromHitbtcName(hitbtcMkt);
    var poloMktElement = poloAllMarkets[poloMktName];
    comparePoloniexHitbtcMktElement(poloMktElement, hitbtcJSON.exchangeData[hitbtcMkt], poloMktName, reportingTimestamp);
  }
}

function comparePoloniexHitbtcMktElement(poloMktElement, hitbtcMktElement, poloMktName, reportingTimestamp) {
  var poloBuyAt = +poloMktElement.lowestAsk;
  var poloSellAt = +poloMktElement.highestBid;
  var hitbtcSellAt = +hitbtcMktElement.bid;
  var hitbtcBuyAt = +hitbtcMktElement.ask;
  outputArbResults(poloBuyAt, poloSellAt, hitbtcSellAt, hitbtcBuyAt, "Hitbtc", poloMktName, reportingTimestamp);
}

function poloMktFromHitbtcName(hitbtcMktName) {
  var poloMktNames = {
    BCNBTC: "BTC_BCN",
    DASHBTC: "BTC_DASH",
    DOGEBTC: "BTC_DOGE",
    LSKBTC: "BTC_LSK",
    MAIDBTC: "BTC_MAID",
    REPBTC: "BTC_REP",
    XEMBTC: "BTC_XEM",
    ETHBTC: "BTC_ETH",
    ZECETH: "ETH_ZEC"
  };
  return poloMktNames[hitbtcMktName];
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9jb21wYXJlUHJpY2luZ0RhdGEuanMiXSwibmFtZXMiOlsiYXJiRW1haWxUaHJlc2hvbGRQZXJjZW50IiwiYXJiUmVwb3J0aW5nVGhyZXNob2xkUGVyY2VudCIsImZvcm1hdFRpbWVzdGFtcCIsInRpbWVTdGFtcCIsInRvU3RyaW5nIiwic2xpY2UiLCJjb21wYXJlUG9sb25pZXhDb2luYmFzZSIsInBvbG9EYXRhIiwiY2JEYXRhIiwiY29pbiIsInBvbG9KU09OIiwiSlNPTiIsInBhcnNlIiwiZXhjaGFuZ2VEYXRhIiwiY2JKU09OIiwiRGF0ZSIsImNvbnNvbGUiLCJsb2ciLCJnZXRUaW1lIiwiY29tcGFyZUN1cnJlbmN5UGFpciIsImNjeTEiLCJjY3kyIiwicG9sb1BhaXIiLCJwb2xvQnV5QXQiLCJsb3dlc3RBc2siLCJjYlNlbGxBdCIsImJpZHMiLCJhcmJPcHBvcnR1bml0eSIsImFyYlBlcmNlbnQiLCJtc2ciLCJ0b0ZpeGVkIiwiY2JCdXlBdCIsImFza3MiLCJwb2xvU2VsbEF0IiwiaGlnaGVzdEJpZCIsImNvbXBhcmVBbGxQb2xvbmlleEJpdHRyZXgiLCJiaXR0cmV4SlNPTiIsInJlcG9ydGluZ1RpbWVzdGFtcCIsInBvbG9UaW1lc3RhbXAiLCJwb2xvQWxsTWFya2V0cyIsImJpdHRyZXhUaW1lc3RhbXAiLCJiaXR0cmV4TWt0IiwicG9sb01rdE5hbWUiLCJwb2xvTWt0RnJvbUJpdHRyZXhOYW1lIiwicG9sb01rdEVsZW1lbnQiLCJjb21wYXJlUG9sb25pZXhCaXR0cmV4TWt0RWxlbWVudCIsImJpdHRyZXhTZWxsQXQiLCJCaWQiLCJiaXR0cmV4QnV5QXQiLCJBc2siLCJvdXRwdXRBcmJSZXN1bHRzIiwiZXhjaGFuZ2UyU2VsbEF0IiwiZXhjaGFuZ2UyQnV5QXQiLCJleGNoYW5nZTJOYW1lIiwibXNnQm9keSIsImJpdHRyZXhNa3ROYW1lIiwicmVwbGFjZSIsImNvbXBhcmVBbGxQb2xvbmlleEhpdGJ0YyIsImhpdGJ0Y0pTT04iLCJoaXRidGNUaW1lc3RhbXAiLCJoaXRidGNNa3QiLCJwb2xvTWt0RnJvbUhpdGJ0Y05hbWUiLCJjb21wYXJlUG9sb25pZXhIaXRidGNNa3RFbGVtZW50IiwiaGl0YnRjTWt0RWxlbWVudCIsImhpdGJ0Y1NlbGxBdCIsImJpZCIsImhpdGJ0Y0J1eUF0IiwiYXNrIiwiaGl0YnRjTWt0TmFtZSIsInBvbG9Na3ROYW1lcyIsIkJDTkJUQyIsIkRBU0hCVEMiLCJET0dFQlRDIiwiTFNLQlRDIiwiTUFJREJUQyIsIlJFUEJUQyIsIlhFTUJUQyIsIkVUSEJUQyIsIlpFQ0VUSCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBSUE7O0FBSkE7Ozs7QUFNQTtBQUNBLElBQU1BLHdCQUF3QixHQUFHLElBQWpDLEMsQ0FDQTs7QUFDQSxJQUFNQyw0QkFBNEIsR0FBRyxHQUFyQztBQUVBOzs7O0FBR0EsU0FBU0MsZUFBVCxDQUF5QkMsU0FBekIsRUFBb0M7QUFDbEMsU0FBT0EsU0FBUyxDQUFDQyxRQUFWLEdBQXFCQyxLQUFyQixDQUEyQixDQUEzQixFQUE2QixFQUE3QixDQUFQO0FBQ0Q7QUFFRDs7Ozs7O0FBSUEsU0FBU0MsdUJBQVQsQ0FBaUNDLFFBQWpDLEVBQTJDQyxNQUEzQyxFQUFtREMsSUFBbkQsRUFBeUQ7QUFFdkQsTUFBSUMsUUFBUSxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0wsUUFBUSxDQUFDTSxZQUFwQixDQUFmO0FBQ0EsTUFBSUMsTUFBTSxHQUFHSCxJQUFJLENBQUNDLEtBQUwsQ0FBV0osTUFBTSxDQUFDSyxZQUFsQixDQUFiO0FBQ0EsTUFBSVYsU0FBUyxHQUFHLElBQUlZLElBQUosRUFBaEI7QUFDQUMsRUFBQUEsT0FBTyxDQUFDQyxHQUFSLFdBQWVmLGVBQWUsQ0FBQ0MsU0FBRCxDQUE5QixnQ0FBK0RJLFFBQVEsQ0FBQ0osU0FBVCxDQUFtQmUsT0FBbkIsS0FBNkJWLE1BQU0sQ0FBQ0wsU0FBUCxDQUFpQmUsT0FBakIsRUFBNUY7QUFDQUMsRUFBQUEsbUJBQW1CLENBQUNoQixTQUFE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SSxTQUpTO0FBS25CQyxJQUFBQSxPQUFPLEVBQUcsVUFMUztBQU1uQkMsSUFBQUEsTUFBTSxFQUFJLFNBTlM7QUFPbkJDLElBQUFBLE1BQU0sRUFBSSxTQVBTO0FBUW5CQyxJQUFBQSxNQUFNLEVBQUksU0FSUztBQVNuQkMsSUFBQUEsTUFBTSxFQUFJO0FBVFMsR0FBckI7QUFXQSxTQUFPVCxZQUFZLENBQUNELGFBQUQsQ0FBbkI7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8qIGNvbXBhcmVQcmljaW5nRGF0YS5qc1xuICogQ29uc29saWRhdGVzIGZ1bmN0aW9uIHRvIGNvbXBhcmUgY3J5cHRvIG1hcmtldHMgbG9va2luZyBmb3Igc2lnbmlmaWNhbnQgYXJiaXRyYWdlIG9wcG9ydHVuaXRpZXMuXG4gKiBTZW5kcyBub3RpZmljYXRpb25zIHdoZW4gbGFyZ2UgYXJiaXRyYWdlIGlzIGRldGVjdGVkLlxuICovXG5pbXBvcnQge1NlbmRNZXNzYWdlfSBmcm9tIFwiLi9zZW5kRU1haWxcIjtcblxuLy8gU2V0IHRoaXMgdG8gYmUgYSBjbGVhciB0cmFkaW5nIG9wcG9ydHVuaXR5XG5jb25zdCBhcmJFbWFpbFRocmVzaG9sZFBlcmNlbnQgPSAxLjI1O1xuLy8gU2V0IHRoaXMgdG8gYmUgdGhlIGZlZXMgYXNzb2NpYXRlZCB3aXRoIHRyYWRpbmdcbmNvbnN0IGFyYlJlcG9ydGluZ1RocmVzaG9sZFBlcmNlbnQgPSAwLjA7XG5cbi8qIGZvcm1hdFRpbWVzdGFtcFxuICogZGVzYzogU2ltcGxlIHV0aWxpdHkgdG8gdHJ1bmNhdGUgdGhlIG91dHB1dCBvZiBsb25nIHRpbWUgc3RhbXBzIHRvIGluY2x1ZGUgb25seSB0aGUgZGF0ZSBhbmQgdGltZSBwYXJ0cy5cbiAqL1xuZnVuY3Rpb24gZm9ybWF0VGltZXN0YW1wKHRpbWVTdGFtcCkge1xuICByZXR1cm4odGltZVN0YW1wLnRvU3RyaW5nKCkuc2xpY2UoMCwyNSkpO1xufVxuXG4vKiBjb21wYXJlUG9sb25pZXhDb2luYmFzZVxuICogZGVzYzogTWFpbiBmdW5jdGlvbiBjYWxsZWQgdG8gY29tcGFyZSB0aGUgUG9sb25pZXggYW5kIENvaW5iYXNlIGNyeXB0byBtYXJrZXRzLlxuICogICAgICAgVGhpcyBmdW5jdGlvbiBpcyBleHBvcnRlZCBhbmQgY2FsbGVkIGJlIGFwcC5qc1xuICovXG5mdW5jdGlvbiBjb21wYXJlUG9sb25pZXhDb2luYmFzZShwb2xvRGF0YSwgY2JEYXRhLCBjb2luKSB7XG5cbiAgdmFyIHBvbG9KU09OID0gSlNPTi5wYXJzZShwb2xvRGF0YS5leGNoYW5nZURhdGEpO1xuICB2YXIgY2JKU09OID0gSlNPTi5wYXJzZShjYkRhdGEuZXhjaGFuZ2VEYXRhKTtcbiAgbGV0IHRpbWVTdGFtcCA9IG5ldyBEYXRlKCk7XG4gIGNvbnNvbGUubG9nKGAke2Zvcm1hdFRpbWVzdGFtcCh0aW1lU3RhbXApfTogUG9sb1RpbWUtQ0JUaW1lOiAke3BvbG9EYXRhLnRpbWVTdGFtcC5nZXRUaW1lKCktY2JEYXRhLnRpbWVTdGFtcC5nZXRUaW1lKCl9LmApO1xuICBjb21wYXJlQ3VycmVuY3lQYWlyKHRpbWVTdGFtcCwgcG9sb0pTT04sIGNiSlNPTiwgXCJVU0RDXCIsIGNvaW4pXG59XG5cbi8qIGNvbXBhcmVDdXJyZW5jeVBhaXJcbiAqIGRlc2M6IENvbXBhcmVzIGEgY3VycmVuY3kgcGFpciBiZXR3ZWVuIFBvbG9uaWV4IGFuZCBDb2luYmFzZS4gIE5vdGlmaWVzIHdoZW4gc2lnbmlmaWNhbnQgYXJiaXRyYWdlIG9wcG9ydHVuaXRpZXNcbiAqICAgICAgIG9jY3VyLlxuICovXG5mdW5jdGlvbiBjb21wYXJlQ3VycmVuY3lQYWlyKHRpbWVTdGFtcCwgcG9sb0pTT04sIGNiSlNPTiwgY2N5MSwgY2N5Mikge1xuICBsZXQgcG9sb1BhaXIgPSBjY3kxK1wiX1wiK2NjeTI7XG4gIGxldCBwb2xvQnV5QXQgPSArcG9sb0pTT05bcG9sb1BhaXJdLmxvd2VzdEFzaztcbiAgbGV0IGNiU2VsbEF0ID0gK2NiSlNPTi5iaWRzWzBdWzBdO1xuICBsZXQgYXJiT3Bwb3J0dW5pdHkgPSBjYlNlbGxBdC1wb2xvQnV5QXQ7XG4gIGxldCBhcmJQZXJjZW50ID0gMTAwKihjYlNlbGxBdC1wb2xvQnV5QXQpLyggKGNiU2VsbEF0K3BvbG9CdXlBdCkgLyAyKTtcbiAgaWYoYXJiUGVyY2VudCA+IGFyYlJlcG9ydGluZ1RocmVzaG9sZFBlcmNlbnQpIHtcbiAgICBsZXQgbXNnID0gYCR7Zm9ybWF0VGltZXN0YW1wKHRpbWVTdGFtcCl9OiBQYWlyOiAke3BvbG9QYWlyfSwgUmVzdWx0OiBHQUlOLCBEZXNjOiAke3BvbG9QYWlyfS4gQlVZIFBvbG8gYXQ6IHBvbG9CdXlBdDogJHtwb2xvQnV5QXQudG9GaXhlZCg4KX0gU0VMTCBDb2luYmFzZSBhdDogJHtjYlNlbGxBdC50b0ZpeGVkKDgpfSwgQW1vdW50OiAke2FyYk9wcG9ydHVuaXR5LnRvRml4ZWQoNyl9LCAke2FyYlBlcmNlbnQudG9GaXhlZCg2KX0lYDtcbiAgICBpZiAoYXJiUGVyY2VudCA+IGFyYkVtYWlsVGhyZXNob2xkUGVyY2VudClcbiAgICAgIFNlbmRNZXNzYWdlKGAke3BvbG9QYWlyfTogQlVZICR7Y2N5Mn0gYXQgUG9sb25pZXggYW5kIFNFTEwgYXQgQ29pbmJhc2VgLCBtc2cpO1xuICAgIGNvbnNvbGUubG9nKG1zZyk7XG4gIH1cbiAgZWxzZSB7XG4gICAgY29uc29sZS5sb2coYCR7Zm9ybWF0VGltZXN0YW1wKHRpbWVTdGFtcCl9OiBQYWlyOiAke3BvbG9QYWlyfSwgUmVzdWx0OiBMT1NTLCBEZXNjOiBwb2xvQnV5QXQ6ICR7cG9sb0J1eUF0LnRvRml4ZWQoOCl9IGNvbXBhcmVkIHRvIGNiU2VsbEF0OiAke2NiU2VsbEF0LnRvRml4ZWQoOCl9LCBESUZGOiAke2FyYk9wcG9ydHVuaXR5LnRvRml4ZWQoNyl9YClcbiAgfVxuICBsZXQgY2JCdXlBdCA9ICtjYkpTT04uYXNrc1swXVswXTtcbiAgbGV0IHBvbG9TZWxsQXQgPSArcG9sb0pTT05bcG9sb1BhaXJdLmhpZ2hlc3RCaWQ7XG4gIGFyYk9wcG9ydHVuaXR5ID0gcG9sb1NlbGxBdC1jYkJ1eUF0O1xuICBhcmJQZXJjZW50ID0gMTAwKihwb2xvU2VsbEF0LWNiQnV5QXQpLyggKHBvbG9TZWxsQXQrY2JCdXlBdCkgLyAyKTtcbiAgaWYoYXJiUGVyY2VudCA+IGFyYlJlcG9ydGluZ1RocmVzaG9sZFBlcmNlbnQpIHtcbiAgICBsZXQgbXNnID0gYCR7Zm9ybWF0VGltZXN0YW1wKHRpbWVTdGFtcCl9OiBQYWlyOiAke3BvbG9QYWlyfSwgUmVzdWx0OiBHQUlOLCBEZXNjOiAke3BvbG9QYWlyfS4gQlVZIENvaW5iYXNlIGF0OiBjYkJ1eUF0OiAke2NiQnV5QXQudG9GaXhlZCg3KX0gU0VMTCBQb2xvIGF0OiAke3BvbG9TZWxsQXQudG9GaXhlZCg3KX0sIEdhaW46ICR7YXJiT3Bwb3J0dW5pdHkudG9GaXhlZCg3KX0sICR7YXJiUGVyY2VudC50b0ZpeGVkKDYpfSVgO1xuICAgIGlmIChhcmJQZXJjZW50ID4gYXJiRW1haWxUaHJlc2hvbGRQZXJjZW50KSBcbiAgICAgIFNlbmRNZXNzYWdlKGAke3BvbG9QYWlyfTogQlVZICR7Y2N5Mn0gYXQgQ29pbmJhc2UgYW5kIFNFTEwgYXQgUG9sb25pZXhgLCBtc2cpO1xuICAgIGNvbnNvbGUubG9nKG1zZyk7XG4gIH1cbiAgZWxzZSB7XG4gICAgY29uc29sZS5sb2coYCR7Zm9ybWF0VGltZXN0YW1wKHRpbWVTdGFtcCl9OiBQYWlyOiAke3BvbG9QYWlyfSwgUmVzdWx0OiBMT1NTLCBEZXNjOiBjYkJ1eUF0OiAke2NiQnV5QXQudG9GaXhlZCg3KX0gY29tcGFyZWQgdG8gcG9sb1NlbGxBdDogJHtwb2xvU2VsbEF0LnRvRml4ZWQoNyl9LCBESUZGOiAke2FyYk9wcG9ydHVuaXR5LnRvRml4ZWQoNyl9YCk7XG4gIH1cbiB9XG5cbiAvKiBjb21wYXJlQWxsUG9sb25pZXhCaXR0cmV4XG4gICogZGVzYzogVGFrZXMgdGhlIHBvbG9uaWV4IGFuZCBiaXR0cmV4IGRhdGEgaW4gSlNPTiBmb3JtYXQgYW5kIGNvbXBhcmVzIGFsbCBvdmVybGFwaW5nIG1hcmtldHMgZm9yIGFyYml0cmFnZS5cbiAgKiAgICAgICBFeHBvcnRlZCBmdW5jdGlvbiBjYWxsZWQgYnkgdGhlIG1haW4gYXBwLmpzXG4gICovXG5mdW5jdGlvbiBjb21wYXJlQWxsUG9sb25pZXhCaXR0cmV4KHBvbG9KU09OLCBiaXR0cmV4SlNPTikge1xuXG4gIGxldCByZXBvcnRpbmdUaW1lc3RhbXAgPSBuZXcgRGF0ZSgpO1xuICBsZXQgcG9sb1RpbWVzdGFtcCA9IHBvbG9KU09OLnRpbWVTdGFtcDtcbiAgbGV0IHBvbG9BbGxNYXJrZXRzID0gSlNPTi5wYXJzZShwb2xvSlNPTi5leGNoYW5nZURhdGEpO1xuICBsZXQgYml0dHJleFRpbWVzdGFtcCA9IGJpdHRyZXhKU09OLnRpbWVTdGFtcDtcbiAgY29uc29sZS5sb2cocG9sb1RpbWVzdGFtcCk7XG4gIGNvbnNvbGUubG9nKGJpdHRyZXhUaW1lc3RhbXApO1xuICBmb3IobGV0IGJpdHRyZXhNa3QgaW4gYml0dHJleEpTT04uZXhjaGFuZ2VEYXRhKXtcbiAgICBsZXQgcG9sb01rdE5hbWUgPSBwb2xvTWt0RnJvbUJpdHRyZXhOYW1lKGJpdHRyZXhNa3QpO1xuICAgIGxldCBwb2xvTWt0RWxlbWVudCA9IHBvbG9BbGxNYXJrZXRzW3BvbG9Na3ROYW1lXTtcbiAgICBjb21wYXJlUG9sb25pZXhCaXR0cmV4TWt0RWxlbWVudChwb2xvTWt0RWxlbWVudCwgYml0dHJleEpTT04uZXhjaGFuZ2VEYXRhW2JpdHRyZXhNa3RdLCBwb2xvTWt0TmFtZSwgcmVwb3J0aW5nVGltZXN0YW1wKVxuICB9XG59XG5cbi8qIGNvbXBhcmVQb2xvbmlleEJpdHRyZXhNa3RFbGVtZW50XG4gKiBkZXNjOiBDb21wYXJlcyBhIHBhcnRpY3VsYXIgbWFya2V0IGJldHdlZW4gdGhlIFBvbG9uaWV4IGFuZCBCaXR0cmV4IGV4Y2hhbmdlcy4gIFNlZG4gbm90aWZpY2F0aW9ucyB3aGVuXG4gKiAgICAgICBzaWduaWZpY2FudCBhcmJpdHJhZ2Ugb3Bwb3J0dW5pdGllcyBleGlzdC5cbiAqL1xuZnVuY3Rpb24gY29tcGFyZVBvbG9uaWV4Qml0dHJleE1rdEVsZW1lbnQocG9sb0pTT04sIGJpdHRyZXhKU09OLCBwb2xvUGFpciwgdGltZVN0YW1wKSB7XG5cbiAgbGV0IHBvbG9CdXlBdCA9ICtwb2xvSlNPTi5sb3dlc3RBc2s7XG4gIGxldCBwb2xvU2VsbEF0ID0gK3BvbG9KU09OLmhpZ2hlc3RCaWQ7XG4gIGxldCBiaXR0cmV4U2VsbEF0ID0gK2JpdHRyZXhKU09OLkJpZDtcbiAgbGV0IGJpdHRyZXhCdXlBdCA9ICtiaXR0cmV4SlNPTi5Bc2s7XG4gIG91dHB1dEFyYlJlc3VsdHMocG9sb0J1eUF0LCBwb2xvU2VsbEF0LCBiaXR0cmV4U2VsbEF0LCBiaXR0cmV4QnV5QXQsIFwiQml0dHJleFwiLCBwb2xvUGFpciwgdGltZVN0YW1wKTtcbn1cblxuZnVuY3Rpb24gb3V0cHV0QXJiUmVzdWx0cyhwb2xvQnV5QXQsIHBvbG9TZWxsQXQsIGV4Y2hhbmdlMlNlbGxBdCwgZXhjaGFuZ2UyQnV5QXQsIGV4Y2hhbmdlMk5hbWUsIHBvbG9QYWlyLCB0aW1lU3RhbXApIHtcblxuICBsZXQgYXJiT3Bwb3J0dW5pdHkgPSBwb2xvU2VsbEF0LWV4Y2hhbmdlMkJ1eUF0O1xuICBsZXQgYXJiUGVyY2VudCA9IDEwMCoocG9sb1NlbGxBdC1leGNoYW5nZTJCdXlBdCkvKCAocG9sb1NlbGxBdCtleGNoYW5nZTJCdXlBdCkgLyAyKTtcbiAgaWYoYXJiUGVyY2VudCA+IGFyYlJlcG9ydGluZ1RocmVzaG9sZFBlcmNlbnQpIHtcbiAgICBsZXQgbXNnID0gYCR7Zm9ybWF0VGltZXN0YW1wKHRpbWVTdGFtcCl9OiBQYWlyOiAke3BvbG9QYWlyfSwgUmVzdWx0OiBHQUlOLCBEZXNjOiAke3BvbG9QYWlyfS4gQlVZIGF0ICR7ZXhjaGFuZ2UyTmFtZX06ICR7ZXhjaGFuZ2UyQnV5QXQudG9GaXhlZCg4KX0gU0VMTCBQb2xvIGF0LCAke3BvbG9TZWxsQXQudG9GaXhlZCg4KX0sIEdhaW4sICR7YXJiT3Bwb3J0dW5pdHkudG9GaXhlZCg3KX0sICR7YXJiUGVyY2VudC50b0ZpeGVkKDYpfSVgO1xuICAgIGNvbnNvbGUubG9nKG1zZyk7XG4gICAgaWYgKGFyYlBlcmNlbnQgPiBhcmJFbWFpbFRocmVzaG9sZFBlcmNlbnQpIHtcbiAgICAgIGxldCBtc2dCb2R5ID0gYCR7cG9sb1BhaXJ9IEJVWSBhdCAke2V4Y2hhbmdlMk5hbWV9IGZvciAke2V4Y2hhbmdlMkJ1eUF0LnRvRml4ZWQoOCl9LiAgU2VsbCBhdCBQb2xvbmlleCBmb3IgJHtwb2xvU2VsbEF0LnRvRml4ZWQoOCl9LCBHYWluOiAke2FyYlBlcmNlbnQudG9GaXhlZCg2KX0lYDtcbiAgICAgIFNlbmRNZXNzYWdlKGAke3BvbG9QYWlyfTogQlVZIGF0ICR7ZXhjaGFuZ2UyTmFtZX0gYW5kIFNFTEwgYXQgUG9sb25pZXhgLCBtc2dCb2R5KTtcbiAgICB9XG4gIH1cbiAgZWxzZSB7XG4gICAgY29uc29sZS5sb2coYCR7Zm9ybWF0VGltZXN0YW1wKHRpbWVTdGFtcCl9OiBQYWlyOiAke3BvbG9QYWlyfSwgUmVzdWx0OiBMT1NTLCBEZXNjOiAke2V4Y2hhbmdlMk5hbWV9LCAke2V4Y2hhbmdlMkJ1eUF0LnRvRml4ZWQoOCl9IGlzIGdyZWF0ZXIgdGhhbiBwb2xvU2VsbEF0LCAke3BvbG9TZWxsQXQudG9GaXhlZCg4KX0sIERJRkYsICR7YXJiT3Bwb3J0dW5pdHkudG9GaXhlZCg2KX1gKTtcbiAgfVxuICBhcmJPcHBvcnR1bml0eSA9IGV4Y2hhbmdlMlNlbGxBdC1wb2xvQnV5QXQ7XG4gIGFyYlBlcmNlbnQgPSAxMDAqKGV4Y2hhbmdlMlNlbGxBdC1wb2xvQnV5QXQpLyggKGV4Y2hhbmdlMlNlbGxBdCtwb2xvQnV5QXQpIC8gMik7XG4gIGlmKGFyYlBlcmNlbnQgPiBhcmJSZXBvcnRpbmdUaHJlc2hvbGRQZXJjZW50KSB7XG4gICAgbGV0IG1zZyA9IGAke2Zvcm1hdFRpbWVzdGFtcCh0aW1lU3RhbXApfTogUGFpcjogJHtwb2xvUGFpcn0sIFJlc3VsdDogR0FJTiwgRGVzYzogJHtwb2xvUGFpcn0uIEJVWSBhdCBQb2xvOiBwb2xvQnV5QXQsICR7cG9sb0J1eUF0LnRvRml4ZWQoOCl9IFNFTEwgJHtleGNoYW5nZTJOYW1lfSBhdCwgJHtleGNoYW5nZTJTZWxsQXQudG9GaXhlZCg4KX0sIEdhaW4sICR7YXJiT3Bwb3J0dW5pdHkudG9GaXhlZCg3KX0sICR7YXJiUGVyY2VudC50b0ZpeGVkKDYpfSVgO1xuICAgIGNvbnNvbGUubG9nKG1zZyk7XG4gICAgaWYgKGFyYlBlcmNlbnQgPiBhcmJFbWFpbFRocmVzaG9sZFBlcmNlbnQpIHtcbiAgICAgIGxldCBtc2dCb2R5ID0gYCR7cG9sb1BhaXJ9IEJVWSBhdCBQb2xvIGZvciAke3BvbG9CdXlBdC50b0ZpeGVkKDgpfS4gIFNlbGwgYXQgJHtleGNoYW5nZTJOYW1lfSBmb3IgJHtleGNoYW5nZTJTZWxsQXQudG9GaXhlZCg4KX0sIEdhaW46ICR7YXJiUGVyY2VudC50b0ZpeGVkKDYpfSVgO1xuICAgICAgU2VuZE1lc3NhZ2UoYCR7cG9sb1BhaXJ9OiBCVVkgYXQgUG9sb25pZXggYW5kIFNFTEwgYXQgJHtleGNoYW5nZTJOYW1lfWAsIG1zZ0JvZHkpO1xuICAgIH1cbiAgfVxuICBlbHNlIHtcbiAgICBjb25zb2xlLmxvZyhgJHtmb3JtYXRUaW1lc3RhbXAodGltZVN0YW1wKX06IFBhaXI6ICR7cG9sb1BhaXJ9LCBSZXN1bHQ6IExPU1MsIERlc2M6IHBvbG9CdXlBdCwgJHtwb2xvQnV5QXQudG9GaXhlZCg4KX0gaXMgZ3JlYXRlciB0aGFuICR7ZXhjaGFuZ2UyTmFtZX1TZWxsQXQsICR7ZXhjaGFuZ2UyU2VsbEF0LnRvRml4ZWQoOCl9LiBESUZGLCAke2FyYk9wcG9ydHVuaXR5LnRvRml4ZWQoNyl9YCk7XG4gIH1cbn1cblxuLyogcG9sb01rdEZyb21CaXR0cmV4TmFtZVxuICogZGVzYzogQ29udmVydHMgYSBCaXR0cmV4IGNyeXB0byBjdXJyZW5jeSBwYWlyIGludG8gdGhlIFBvbG9uaWV4IHBhaXIuXG4gKi9cbmZ1bmN0aW9uIHBvbG9Na3RGcm9tQml0dHJleE5hbWUoYml0dHJleE1rdE5hbWUpIHtcbiAgcmV0dXJuKGJpdHRyZXhNa3ROYW1lLnJlcGxhY2UoXCItXCIsIFwiX1wiKSk7XG59XG5cbi8qIGNvbXBhcmVBbGxQb2xvbmlleEhpdGJ0Y1xuKiAgZGVzYzogVGFrZXMgdGhlIHBvbG9uaWV4IGFuZCBoaXRidGMgZGF0YSBpbiBKU09OIGZvcm1hdCBhbmQgY29tcGFyZXMgYWxsIG92ZXJsYXBpbmcgbWFya2V0cyBmb3IgYXJiaXRyYWdlLlxuKiAgICAgICBFeHBvcnRlZCBmdW5jdGlvbiBjYWxsZWQgYnkgdGhlIG1haW4gYXBwLmpzXG4qL1xuZnVuY3Rpb24gY29tcGFyZUFsbFBvbG9uaWV4SGl0YnRjKHBvbG9KU09OLCBoaXRidGNKU09OKSB7XG4gIFxuICBsZXQgcmVwb3J0aW5nVGltZXN0YW1wID0gbmV3IERhdGUoKTtcbiAgbGV0IHBvbG9UaW1lc3RhbXAgPSBwb2xvSlNPTi50aW1lU3RhbXA7XG4gIGxldCBwb2xvQWxsTWFya2V0cyA9IEpTT04ucGFyc2UocG9sb0pTT04uZXhjaGFuZ2VEYXRhKTtcbiAgbGV0IGhpdGJ0Y1RpbWVzdGFtcCA9IGhpdGJ0Y0pTT04udGltZVN0YW1wO1xuICBjb25zb2xlLmxvZyhwb2xvVGltZXN0YW1wKTtcbiAgY29uc29sZS5sb2coaGl0YnRjVGltZXN0YW1wKTtcbiAgZm9yKGxldCBoaXRidGNNa3QgaW4gaGl0YnRjSlNPTi5leGNoYW5nZURhdGEpe1xuICAgIGxldCBwb2xvTWt0TmFtZSA9IHBvbG9Na3RGcm9tSGl0YnRjTmFtZShoaXRidGNNa3QpO1xuICAgIGxldCBwb2xvTWt0RWxlbWVudCA9IHBvbG9BbGxNYXJrZXRzW3BvbG9Na3ROYW1lXTtcbiAgICBjb21wYXJlUG9sb25pZXhIaXRidGNNa3RFbGVtZW50KHBvbG9Na3RFbGVtZW50LCBoaXRidGNKU09OLmV4Y2hhbmdlRGF0YVtoaXRidGNNa3RdLCBwb2xvTWt0TmFtZSwgcmVwb3J0aW5nVGltZXN0YW1wKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjb21wYXJlUG9sb25pZXhIaXRidGNNa3RFbGVtZW50KHBvbG9Na3RFbGVtZW50LCBoaXRidGNNa3RFbGVtZW50LCBwb2xvTWt0TmFtZSwgcmVwb3J0aW5nVGltZXN0YW1wKSB7XG5cbiAgbGV0IHBvbG9CdXlBdCA9ICtwb2xvTWt0RWxlbWVudC5sb3dlc3RBc2s7XG4gIGxldCBwb2xvU2VsbEF0ID0gK3BvbG9Na3RFbGVtZW50LmhpZ2hlc3RCaWQ7XG4gIGxldCBoaXRidGNTZWxsQXQgPSAraGl0YnRjTWt0RWxlbWVudC5iaWQ7XG4gIGxldCBoaXRidGNCdXlBdCA9ICtoaXRidGNNa3RFbGVtZW50LmFzaztcbiAgb3V0cHV0QXJiUmVzdWx0cyhwb2xvQnV5QXQsIHBvbG9TZWxsQXQsIGhpdGJ0Y1NlbGxBdCwgaGl0YnRjQnV5QXQsIFwiSGl0YnRjXCIsIHBvbG9Na3ROYW1lLCByZXBvcnRpbmdUaW1lc3RhbXApO1xufVxuXG5mdW5jdGlvbiBwb2xvTWt0RnJvbUhpdGJ0Y05hbWUoaGl0YnRjTWt0TmFtZSkge1xuXG4gIGNvbnN0IHBvbG9Na3ROYW1lcyA9IHtcbiAgICBCQ05CVEM6ICAgXCJCVENfQkNOXCIsXG4gICAgREFTSEJUQzogIFwiQlRDX0RBU0hcIixcbiAgICBET0dFQlRDOiAgXCJCVENfRE9HRVwiLFxuICAgIExTS0JUQzogICBcIkJUQ19MU0tcIixcbiAgICBNQUlEQlRDOiAgXCJCVENfTUFJRFwiLFxuICAgIFJFUEJUQzogICBcIkJUQ19SRVBcIixcbiAgICBYRU1CVEM6ICAgXCJCVENfWEVNXCIsXG4gICAgRVRIQlRDOiAgIFwiQlRDX0VUSFwiLFxuICAgIFpFQ0VUSDogICBcIkVUSF9aRUNcIlxuICB9O1xuICByZXR1cm4ocG9sb01rdE5hbWVzW2hpdGJ0Y01rdE5hbWVdKTtcbn1cblxuZXhwb3J0IHtjb21wYXJlUG9sb25pZXhDb2luYmFzZSwgY29tcGFyZUFsbFBvbG9uaWV4Qml0dHJleCwgY29tcGFyZUFsbFBvbG9uaWV4SGl0YnRjfTtcbiJdfQ==